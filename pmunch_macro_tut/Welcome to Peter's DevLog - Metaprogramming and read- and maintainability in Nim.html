<html><head>
<title>Welcome to Peter's DevLog - Metaprogramming and read- and maintainability in Nim</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=0.7">
<link href="Welcome%20to%20Peter's%20DevLog%20-%20Metaprogramming%20and%20read-%20and%20maintainability%20in%20Nim_files/css_002.css" rel="stylesheet" type="text/css">
<link href="Welcome%20to%20Peter's%20DevLog%20-%20Metaprogramming%20and%20read-%20and%20maintainability%20in%20Nim_files/css.css" rel="stylesheet" type="text/css">
<link rel="stylesheet" type="text/css" href="Welcome%20to%20Peter's%20DevLog%20-%20Metaprogramming%20and%20read-%20and%20maintainability%20in%20Nim_files/styles.css">
<link rel="stylesheet" type="text/css" href="Welcome%20to%20Peter's%20DevLog%20-%20Metaprogramming%20and%20read-%20and%20maintainability%20in%20Nim_files/cmun-serif.css">
<link rel="stylesheet" href="Welcome%20to%20Peter's%20DevLog%20-%20Metaprogramming%20and%20read-%20and%20maintainability%20in%20Nim_files/github.css">
<link rel="icon" type="image/png" href="https://peterme.net/favicon.png">
<script src="Welcome%20to%20Peter's%20DevLog%20-%20Metaprogramming%20and%20read-%20and%20maintainability%20in%20Nim_files/highlight.js"></script>
<script src="Welcome%20to%20Peter's%20DevLog%20-%20Metaprogramming%20and%20read-%20and%20maintainability%20in%20Nim_files/highlight_002.js"></script><style type="text/css">.hljs-ln{border-collapse:collapse}.hljs-ln td{padding:0}.hljs-ln-n:before{content:attr(data-line-number)}</style>
</head>
<body onload="moveCouch();" style="visibility: visible;">
<div id="leftbar">
<div class="sidebarButtonBox">
<img class="sidebarButton" id="arrow" onclick="toggleBar()" onmouseover="showLabel('hideLabel')" onmouseleave="hideLabel('hideLabel')" src="Welcome%20to%20Peter's%20DevLog%20-%20Metaprogramming%20and%20read-%20and%20maintainability%20in%20Nim_files/back.svg">
<span class="sidebarButtonLabel" id="hideLabel">Hide</span>
</div>
<div class="sidebarButtonBox">
<a href="https://peterme.net/scraps/"><img class="sidebarButton" onmouseover="showLabel('homeLabel')" onmouseleave="hideLabel('homeLabel')" src="Welcome%20to%20Peter's%20DevLog%20-%20Metaprogramming%20and%20read-%20and%20maintainability%20in%20Nim_files/note.svg"></a>
<span class="sidebarButtonLabel" id="homeLabel">Scraps</span>
</div>
<div class="sidebarButtonBox">
<a href="https://peterme.net/rss/"><img class="sidebarButton" onmouseover="showLabel('rssLabel')" onmouseleave="hideLabel('rssLabel')" src="Welcome%20to%20Peter's%20DevLog%20-%20Metaprogramming%20and%20read-%20and%20maintainability%20in%20Nim_files/rss.svg"></a>
<span class="sidebarButtonLabel" id="rssLabel">RSS</span>
</div>
<div id="sidebar">
<div id="sidebarContent">
<a href="https://peterme.net/">
<div id="title">
<span class="letter">P</span>eter's <span class="letter">D</span>evLog
</div>
</a>
<!-- <p>
<p style="text-align: justify;">I&#39;m a computer scientist student from Norway with interests in tinkering, open source, and game development.</p>

<p style="text-align: justify;">This log is intended as a way to both share my projects and keep myself from forgetting them.</p>

<p style="text-align: justify;">If you have any commentary please direct them to me by e-mail: devlog@peterme.net, any e-mail content can be reproduced on this site without further notice.</p>
</p>
<div id="homebutton">
<a href="https://peterme.net/">View all entries</a>
</div> -->
</div>
</div>
</div>
<div id="rightbar">
	<div id="rightbarContent">
		
    
                		<div class="post">
		<h1><a href="https://peterme.net/metaprogramming-and-read-and-maintainability-in-nim.html">Metaprogramming and read- and maintainability in Nim</a></h1>
		<h3>4th June 2019		-     			    			<a href="https://peterme.net/tags/guide.html">Guide</a>
    		        		        		    			,    			<a href="https://peterme.net/tags/nim.html">Nim</a>
    		        		        		    			,    			<a href="https://peterme.net/tags/programming.html">Programming</a></h3>
		<p>
					</p><p>One thing I've mentioned about metaprogramming in Nim, both 
in posts on this site and in talks, is that metaprogramming in Nim can 
enhance read- and maintainability. Opponents of metaprogramming would 
probably sneer at that and remark that it's quite the opposite. And 
sure, metaprogramming is a powerful tool, and with any sufficiently 
powerful tool you have to be careful. The same way a chainsaw can take 
your leg off if you're not careful, a poorly written macro can seriously
 mess up your program. But that doesn't mean we shouldn't use chainsaws,
 or macros! Maybe where I uses templates and macros the most in Nim is 
not to do some strange and crazy things, it's simply to rewrite my code 
so that it becomes more readable, without sacrificing performance. Since
 they are resolved on compile-time, and not while our program is 
running, we can add as much abstraction and complexity we want as long 
as we make sure the output is nice and efficient.</p>

<p>In this post I want to show a small example of refactoring your code 
with macros and templates in order to make it more readable. I'll be 
using a small hobby project I'm working on as the example, namely a 
small RPN calculator that I wrote the other night and want to expand 
into a spiritual HP-41C successor. The program is quite simple, but I've
 removed some of the operators to shorten it down a bit.</p>

<pre><code class="hljs nimrod"><table class="hljs-ln"><tbody><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="1"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">import</span> math, strutils</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="2"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"> </div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="3"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-comment"># We define an enum with our built in commands</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="4"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">type</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="5"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-type">Commands</span> = <span class="hljs-keyword">enum</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="6"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-type">Plus</span> = <span class="hljs-string">"+"</span>, <span class="hljs-type">Minus</span> = <span class="hljs-string">"-"</span>, <span class="hljs-type">Multiply</span> = <span class="hljs-string">"*"</span>, <span class="hljs-type">Divide</span> = <span class="hljs-string">"/"</span>, <span class="hljs-type">Pop</span> = <span class="hljs-string">"pop"</span>,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="7"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-type">StackSwap</span> = <span class="hljs-string">"swap"</span>, <span class="hljs-type">StackRotate</span> = <span class="hljs-string">"rot"</span>, <span class="hljs-type">Help</span> = <span class="hljs-string">"help"</span>, <span class="hljs-type">Exit</span> = <span class="hljs-string">"exit"</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="8"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"> </div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="9"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-comment"># Give them some documentation strings</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="10"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">const</span> docstrings: <span class="hljs-built_in">array</span>[<span class="hljs-type">Commands</span>, <span class="hljs-built_in">string</span>] = [</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="11"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-string">"Adds two numbers"</span>,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="12"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-string">"Subtract two numbers"</span>,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="13"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-string">"Multiplies two numbers"</span>,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="14"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-string">"Divides two numbers"</span>,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="15"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-string">"Pops a number off the stack"</span>,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="16"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-string">"Swaps the two bottom elements on the stack"</span>,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="17"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-string">"Rotates the stack one level"</span>,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="18"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-string">"Lists all the commands with documentation"</span>,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="19"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-string">"Exits the program"</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="20"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">]</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="21"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"> </div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="22"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-comment"># Then create a simple "stack" implementation</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="23"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">var</span> stack: <span class="hljs-built_in">seq</span>[<span class="hljs-built_in">float</span>]</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="24"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"> </div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="25"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">proc</span> push[T](stack: <span class="hljs-keyword">var</span> <span class="hljs-built_in">seq</span>[T], value: T) =</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="26"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  stack.add value</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="27"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"> </div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="28"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">proc</span> pop[T](stack: <span class="hljs-keyword">var</span> <span class="hljs-built_in">seq</span>[T]): T =</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="29"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-literal">result</span> = stack[^<span class="hljs-number">1</span>]</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="30"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  stack.setLen(stack.len - <span class="hljs-number">1</span>)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="31"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"> </div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="32"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-comment"># Convenience template to execute an operation over two operands from the stack</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="33"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">template</span> execute[T](stack: <span class="hljs-keyword">var</span> <span class="hljs-built_in">seq</span>[T], operation: untyped): untyped <span class="hljs-meta">{.dirty.}</span> =</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="34"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-keyword">let</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="35"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    a = stack[^<span class="hljs-number">1</span>]</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="36"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    b = stack[^<span class="hljs-number">2</span>]</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="37"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  stack.setLen(stack.len - <span class="hljs-number">2</span>)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="38"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  stack.push(operation)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="39"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"> </div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="40"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-comment"># Program main loop, read input from stdin, try to parse it as a command and</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="41"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-comment"># run it's corresponding operation, if that fails try to push it as a number.</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="42"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-comment"># Print out our "stack" for every iteration of the loop</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="43"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">while</span> <span class="hljs-literal">true</span>:</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="44"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-keyword">for</span> command <span class="hljs-keyword">in</span> <span class="hljs-literal">stdin</span>.readLine.split(<span class="hljs-string">" "</span>):</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="45"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">try</span>:</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="46"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      <span class="hljs-keyword">case</span> parseEnum[<span class="hljs-type">Commands</span>](command):</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="47"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      <span class="hljs-keyword">of</span> <span class="hljs-type">Plus</span>: stack.execute(a + b)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="48"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      <span class="hljs-keyword">of</span> <span class="hljs-type">Minus</span>: stack.execute(b - a)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="49"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      <span class="hljs-keyword">of</span> <span class="hljs-type">Multiply</span>: stack.execute(a * b)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="50"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      <span class="hljs-keyword">of</span> <span class="hljs-type">Divide</span>: stack.execute(b / a)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="51"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      <span class="hljs-keyword">of</span> <span class="hljs-type">Pop</span>: <span class="hljs-keyword">discard</span> stack.pop</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="52"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      <span class="hljs-keyword">of</span> <span class="hljs-type">StackSwap</span>:</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="53"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">let</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="54"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">          a = stack[^<span class="hljs-number">1</span>]</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="55"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">          b = stack[^<span class="hljs-number">2</span>]</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="56"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        stack[^<span class="hljs-number">1</span>] = b</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="57"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        stack[^<span class="hljs-number">2</span>] = a</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="58"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      <span class="hljs-keyword">of</span> <span class="hljs-type">StackRotate</span>:</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="59"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        stack.insert(stack.pop, <span class="hljs-number">0</span>)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="60"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      <span class="hljs-keyword">of</span> <span class="hljs-type">Help</span>:</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="61"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        echo <span class="hljs-string">"Commands:"</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="62"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">for</span> command <span class="hljs-keyword">in</span> <span class="hljs-type">Commands</span>:</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="63"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">          echo <span class="hljs-string">"\t"</span>, command, <span class="hljs-string">"\t"</span>, docstrings[command]</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="64"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      <span class="hljs-keyword">of</span> <span class="hljs-type">Exit</span>: quit <span class="hljs-number">0</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="65"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">except</span>:</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="66"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      stack.push parseFloat(command)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="67"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    echo stack, <span class="hljs-string">" - "</span>, command</div></td></tr></tbody></table></code></pre>

<h2>A primer on RPN</h2>

<p>Now to make sure you know what this code does I'll quickly explain 
how a RPN calculator works. Instead of infixing the operators like "2 + 3
 =" and get a result, in this case 5, these kinds of calculators work 
with a stack. Plus is an operator that takes two arguments, so we need 
to push two numbers onto the stack and then hit plus "2 3 +". This will 
pop the two elements off the stack, add them together and push the 
result back onto the stack. This makes it very easy to solve more 
complex pieces like "(2 + 3) * (8 / 2)" without the need for 
parenthesis. Simply run "2 3 +" and the stack now contains the number 5,
 then run "8 2 /" and the stack contains the numbers 5 and 4, then 
hitting "*" will multiply these together and leave 20 on the stack. Not 
only are these calculators easy to use once you get used to them, but 
also super easy to implement as you've seen above. Note that if you run 
the example you can either enter each number or command separated by 
hitting enter, or by spaces.</p>

<h2>Refactoring our code to use macros</h2>

<p>So now that we have a grasp on what we're actually working on, lets 
start with the refactoring. As you can see I've taken the liberty of 
adding a simple execute template already. It simply takes a statement 
which has the symbols "a" and "b" available to it and pushes the result 
to the stack. This is to avoid having to manually do all the poping, 
pushing, and storing of variables. The next step however is a bit more 
interesting. Notice that if we want to add a new operator we need to do 
three modifications in three different places. First add it to the enum,
 with the string command that is used to run it. Then write a docstring 
at the correct place in the array. And finally implement the new feature
 in the case switch in our main loop. Thankfully Nim's type system is 
able to save us from a lot of things that could go wrong. Case switches 
are strict, meaning that the compiler will complain if we haven't 
implement all cases, or if we implement too many. And arrays defined 
over an enum type will make sure we don't put too many, or too few 
elements in it. But this is still not quite enough, we might end up 
writing our doctsring in the wrong spot, which would shift over all the 
others. And having to jump around the file to three different places 
isn't optimal. So let's try to solve this with a little pinch of 
metaprogramming.</p>

<p>So we want to create a simple definition syntax for our operations. 
It should include the name of the operation, the string to call it by, 
the docstring, and of course the operation itself. I ended up with going
 for a this:</p>

<pre><code class="hljs nimrod"><table class="hljs-ln"><tbody><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="1"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-type">Plus</span> = <span class="hljs-string">"+"</span>; <span class="hljs-string">"Adds two numbers"</span>:</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="2"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  stack.execute(a + b)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="3"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-type">Minus</span> = <span class="hljs-string">"-"</span>; <span class="hljs-string">"Subtract two numbers"</span>:</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="4"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  stack.execute(b - a)</div></td></tr></tbody></table></code></pre>

<p>It's compact, it's understandable, and easily maintainable. Now we 
just need to make it work! Nim sees this input as this syntax tree (only
 the plus is represented here for brevity)</p>

<pre>StmtList
  Asgn
    Ident "Plus"
    StrLit "+"
  Call
    StrLit "Adds two numbers"
    StmtList
      Call
        DotExpr
          Ident "stack"
          Ident "execute"
        Infix
          Ident "+"
          Ident "a"
          Ident "b"
</pre>

<p>After having figured out our input, we need to figure out what code 
we want this to generate. The type definition and docstring are both on 
the top level, so those can be generated directly. But the case switch 
is inside our main loop, so let's put that in a template, and then 
simply call that from our loop.</p>

<h2>Creating the enum</h2>

<p>Running <code>dumpTree</code> on a standard enum type definition shows us how to generate one:</p>

<pre>StmtList
  TypeSection
    TypeDef
      Ident "Commands"
      Empty
      EnumTy
        Empty
        EnumFieldDef
          Ident "Plus"
          StrLit "+"
        EnumFieldDef
          Ident "Minus"
          StrLit "-"
</pre>

<p>The part here that is interesting to us is the <code>EnumFieldDef</code> nodes. By creating an <code>EnumTy</code> node with the first <code>Empty</code> node, and then iterating over the <code>Asgn</code> nodes in our input and copying the <code>Ident</code> and <code>StrLit</code> into an <code>EnumFieldDef</code> node which is added to the <code>EnumTy</code>
 node we can build up the inner structure of this tree. Then it's just a
 matter of putting it into the outer shell and our enum is done.</p>

<p>Although we're still just echoing out our resulting enum we can see that we now create what we wanted:</p>

<pre><code class="hljs nimrod"><table class="hljs-ln"><tbody><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="1"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">import</span> macros</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="2"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"> </div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="3"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">macro</span> defineCommands(definitions: untyped): untyped =</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="4"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-literal">result</span> = newstmtlist()</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="5"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  echo <span class="hljs-string">"This is the input to our macro"</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="6"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  echo definitions.treeRepr</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="7"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-keyword">var</span> enumDef = nnkTypeSection.newTree(</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="8"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      nnkTypeDef.newTree(</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="9"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        newIdentNode(<span class="hljs-string">"Commands"</span>),</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="10"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        newEmptyNode(),</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="11"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        nnkEnumTy.newTree(newEmptyNode())))</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="12"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> countup(<span class="hljs-number">0</span>, definitions.len - <span class="hljs-number">1</span>, <span class="hljs-number">2</span>):</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="13"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">let</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="14"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      enumInfo = definitions[i]</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="15"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      commandInfo = definitions[i+<span class="hljs-number">1</span>].treeRepr</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="16"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    enumDef[<span class="hljs-number">0</span>][<span class="hljs-number">2</span>].add nnkEnumFieldDef.newtree(enumInfo[<span class="hljs-number">0</span>], enumInfo[<span class="hljs-number">1</span>])</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="17"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  echo <span class="hljs-string">"This is the enum we create"</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="18"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  echo enumDef.treeRepr</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="19"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"> </div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="20"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">static</span>: echo <span class="hljs-string">"This is what we want"</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="21"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">dumpTree:</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="22"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-keyword">type</span> <span class="hljs-type">Commands</span> = <span class="hljs-keyword">enum</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="23"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-type">Plus</span> = <span class="hljs-string">"+"</span>, <span class="hljs-type">Minus</span> = <span class="hljs-string">"-"</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="24"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"> </div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="25"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">defineCommands:</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="26"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-type">Plus</span> = <span class="hljs-string">"+"</span>; <span class="hljs-string">"Adds two numbers"</span>:</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="27"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    stack.execute(a + b)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="28"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-type">Minus</span> = <span class="hljs-string">"-"</span>; <span class="hljs-string">"Subtract two numbers"</span>:</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="29"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    stack.execute(b - a)</div></td></tr></tbody></table></code></pre>

<h2>Creating the docstring array</h2>

<p>Next up is the docstring array. The structure for this has a lot more
 static parts. Notice how above most of our stuff was generated in a 
loop, but this will only require us to copy the <code>StrLit</code> nodes into a shell:</p>

<pre>ConstSection
  ConstDef
    Ident "docstrings"
    BracketExpr
      Ident "array"
      Ident "Commands"
      Ident "string"
    Bracket
      StrLit "Adds two numbers"
      StrLit "Subtract two numbers"
</pre>

<p>Doing the same as we did with our enum and creating an empty tree 
that we populate in the loop we end up with something like this:</p>

<pre><code class="hljs nimrod"><table class="hljs-ln"><tbody><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="1"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">import</span> macros</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="2"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"> </div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="3"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">macro</span> defineCommands(definitions: untyped): untyped =</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="4"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-literal">result</span> = newstmtlist()</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="5"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  echo <span class="hljs-string">"This is the input to our macro"</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="6"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  echo definitions.treeRepr</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="7"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-keyword">var</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="8"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    enumDef = nnkTypeSection.newTree(</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="9"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      nnkTypeDef.newTree(</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="10"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        newIdentNode(<span class="hljs-string">"Commands"</span>),</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="11"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        newEmptyNode(),</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="12"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        nnkEnumTy.newTree(newEmptyNode())))</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="13"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    docstrings =  nnkConstSection.newTree(</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="14"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      nnkConstDef.newTree(</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="15"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        newIdentNode(<span class="hljs-string">"docstrings"</span>),</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="16"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        nnkBracketExpr.newTree(</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="17"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">          newIdentNode(<span class="hljs-string">"array"</span>),</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="18"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">          newIdentNode(<span class="hljs-string">"Commands"</span>),</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="19"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">          newIdentNode(<span class="hljs-string">"string"</span>)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="20"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        ),</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="21"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        nnkBracket.newTree()))</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="22"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> countup(<span class="hljs-number">0</span>, definitions.len - <span class="hljs-number">1</span>, <span class="hljs-number">2</span>):</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="23"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">let</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="24"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      enumInfo = definitions[i]</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="25"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      commandInfo = definitions[i+<span class="hljs-number">1</span>]</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="26"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    enumDef[<span class="hljs-number">0</span>][<span class="hljs-number">2</span>].add nnkEnumFieldDef.newtree(enumInfo[<span class="hljs-number">0</span>], enumInfo[<span class="hljs-number">1</span>])</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="27"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    docstrings[<span class="hljs-number">0</span>][<span class="hljs-number">2</span>].add commandInfo[<span class="hljs-number">0</span>]</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="28"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  echo <span class="hljs-string">"This is the enum we create"</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="29"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  echo enumDef.treeRepr</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="30"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  echo <span class="hljs-string">"This is the docstring array we create"</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="31"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  echo docstrings.treeRepr</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="32"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"> </div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="33"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">static</span>: echo <span class="hljs-string">"This is what we want"</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="34"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">dumpTree:</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="35"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-keyword">const</span> docstrings: <span class="hljs-built_in">array</span>[<span class="hljs-type">Commands</span>, <span class="hljs-built_in">string</span>] = [</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="36"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-string">"Adds two numbers"</span>,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="37"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-string">"Subtract two numbers"</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="38"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  ]</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="39"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"> </div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="40"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">defineCommands:</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="41"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-type">Plus</span> = <span class="hljs-string">"+"</span>; <span class="hljs-string">"Adds two numbers"</span>:</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="42"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    stack.execute(a + b)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="43"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-type">Minus</span> = <span class="hljs-string">"-"</span>; <span class="hljs-string">"Subtract two numbers"</span>:</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="44"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    stack.execute(b - a)</div></td></tr></tbody></table></code></pre>

<h2>Creating our case switch template</h2>

<p>In a familiar vein we can now create our case switch by first creating an empty tree of a case statement, then adding <code>OfBranch</code> nodes to it in our loop.</p>

<pre>CaseStmt
  Call
    BracketExpr
      Ident "parseEnum"
      Ident "Commands"
    Ident "command"
  OfBranch
    Ident "Plus"
    StmtList
      &lt;nodes of the actual code comes here&gt;</pre>

<p>And we end up with something like this:</p>

<pre><code class="hljs nimrod"><table class="hljs-ln"><tbody><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="1"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">import</span> macros</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="2"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"> </div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="3"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">macro</span> defineCommands(definitions: untyped): untyped =</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="4"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-literal">result</span> = newstmtlist()</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="5"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  echo <span class="hljs-string">"This is the input to our macro"</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="6"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  echo definitions.treeRepr</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="7"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-keyword">var</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="8"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    enumDef = nnkTypeSection.newTree(</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="9"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      nnkTypeDef.newTree(</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="10"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        newIdentNode(<span class="hljs-string">"Commands"</span>),</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="11"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        newEmptyNode(),</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="12"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        nnkEnumTy.newTree(newEmptyNode())))</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="13"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    docstrings =  nnkConstSection.newTree(</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="14"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      nnkConstDef.newTree(</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="15"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        newIdentNode(<span class="hljs-string">"docstrings"</span>),</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="16"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        nnkBracketExpr.newTree(</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="17"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">          newIdentNode(<span class="hljs-string">"array"</span>),</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="18"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">          newIdentNode(<span class="hljs-string">"Commands"</span>),</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="19"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">          newIdentNode(<span class="hljs-string">"string"</span>)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="20"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        ),</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="21"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        nnkBracket.newTree()))</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="22"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    caseSwitch =  nnkCaseStmt.newTree(</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="23"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      nnkCall.newTree(</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="24"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        nnkBracketExpr.newTree(</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="25"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">          newIdentNode(<span class="hljs-string">"parseEnum"</span>),</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="26"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">          newIdentNode(<span class="hljs-string">"Commands"</span>)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="27"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        ),</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="28"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        newIdentNode(<span class="hljs-string">"command"</span>)))</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="29"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> countup(<span class="hljs-number">0</span>, definitions.len - <span class="hljs-number">1</span>, <span class="hljs-number">2</span>):</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="30"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">let</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="31"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      enumInfo = definitions[i]</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="32"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      commandInfo = definitions[i+<span class="hljs-number">1</span>]</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="33"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    enumDef[<span class="hljs-number">0</span>][<span class="hljs-number">2</span>].add nnkEnumFieldDef.newtree(enumInfo[<span class="hljs-number">0</span>], enumInfo[<span class="hljs-number">1</span>])</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="34"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    docstrings[<span class="hljs-number">0</span>][<span class="hljs-number">2</span>].add commandInfo[<span class="hljs-number">0</span>]</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="35"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    caseSwitch.add nnkOfBranch.newTree(</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="36"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      enumInfo[<span class="hljs-number">0</span>],</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="37"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      commandInfo[<span class="hljs-number">1</span>])</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="38"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  echo <span class="hljs-string">"This is the enum we create"</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="39"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  echo enumDef.treeRepr</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="40"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  echo <span class="hljs-string">"This is the docstring array we create"</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="41"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  echo docstrings.treeRepr</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="42"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  echo <span class="hljs-string">"This is the case statement we create"</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="43"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  echo caseSwitch.treeRepr</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="44"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"> </div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="45"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">static</span>: echo <span class="hljs-string">"This is what we want"</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="46"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">dumpTree:</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="47"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-keyword">case</span> parseEnum[<span class="hljs-type">Commands</span>](command):</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="48"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-keyword">of</span> <span class="hljs-type">Plus</span>: stack.execute(a + b)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="49"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"> </div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="50"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">defineCommands:</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="51"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-type">Plus</span> = <span class="hljs-string">"+"</span>; <span class="hljs-string">"Adds two numbers"</span>:</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="52"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    stack.execute(a + b)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="53"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-type">Minus</span> = <span class="hljs-string">"-"</span>; <span class="hljs-string">"Subtract two numbers"</span>:</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="54"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    stack.execute(b - a)</div></td></tr></tbody></table></code></pre>

<h2>Tying it all together and generating the correct code</h2>

<p>So far we've just focused on creating the expected output. But we 
have some extra considerations to make. What if we want to call the 
macro multiple times, say from different modules? And what about the 
template we talked about? So let's change our macro definition a bit to 
take some more arguments that we can use to name the things our code 
creates. We add arguments to name the enum, the array of docstrings, and
 the name of the template we want to create. Then we tie everything 
together in a call to <code>quote</code> which adds our sections and the
 template. Then adding back all our definitions and our main loop, and 
our final program ends up looking like this:</p>

<pre><code class="hljs nimrod"><table class="hljs-ln"><tbody><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="1"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">import</span> math, strutils</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="2"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">import</span> macros</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="3"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"> </div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="4"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">macro</span> defineCommands(enumName, docarrayName, runnerName,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="5"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  definitions: untyped): untyped =</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="6"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-keyword">var</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="7"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    enumDef = nnkTypeSection.newTree(</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="8"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      nnkTypeDef.newTree(</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="9"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        enumName,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="10"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        newEmptyNode(),</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="11"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        nnkEnumTy.newTree(newEmptyNode())))</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="12"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    docstrings =  nnkConstSection.newTree(</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="13"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      nnkConstDef.newTree(</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="14"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        docarrayName,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="15"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        nnkBracketExpr.newTree(</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="16"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">          newIdentNode(<span class="hljs-string">"array"</span>),</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="17"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">          enumName,</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="18"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">          newIdentNode(<span class="hljs-string">"string"</span>)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="19"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        ),</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="20"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        nnkBracket.newTree()))</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="21"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    templateArgument = newIdentNode(<span class="hljs-string">"command"</span>)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="22"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    caseSwitch =  nnkCaseStmt.newTree(</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="23"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      nnkCall.newTree(</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="24"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        nnkBracketExpr.newTree(</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="25"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">          newIdentNode(<span class="hljs-string">"parseEnum"</span>),</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="26"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">          enumName</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="27"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        ),</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="28"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">        templateArgument))</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="29"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> countup(<span class="hljs-number">0</span>, definitions.len - <span class="hljs-number">1</span>, <span class="hljs-number">2</span>):</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="30"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">let</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="31"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      enumInfo = definitions[i]</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="32"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      commandInfo = definitions[i+<span class="hljs-number">1</span>]</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="33"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    enumDef[<span class="hljs-number">0</span>][<span class="hljs-number">2</span>].add nnkEnumFieldDef.newtree(enumInfo[<span class="hljs-number">0</span>], enumInfo[<span class="hljs-number">1</span>])</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="34"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    docstrings[<span class="hljs-number">0</span>][<span class="hljs-number">2</span>].add commandInfo[<span class="hljs-number">0</span>]</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="35"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    caseSwitch.add nnkOfBranch.newTree(</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="36"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      enumInfo[<span class="hljs-number">0</span>],</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="37"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      commandInfo[<span class="hljs-number">1</span>])</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="38"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-literal">result</span> = quote <span class="hljs-keyword">do</span>:</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="39"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    `enumDef`</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="40"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    `docstrings`</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="41"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">template</span> `runnerName`(`templateArgument`: untyped): untyped =</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="42"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      `caseSwitch`</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="43"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  echo <span class="hljs-literal">result</span>.repr</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="44"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"> </div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="45"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-comment"># First create a simple "stack" implementation</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="46"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">var</span> stack: <span class="hljs-built_in">seq</span>[<span class="hljs-built_in">float</span>]</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="47"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"> </div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="48"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">proc</span> push[T](stack: <span class="hljs-keyword">var</span> <span class="hljs-built_in">seq</span>[T], value: T) =</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="49"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  stack.add value</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="50"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"> </div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="51"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">proc</span> pop[T](stack: <span class="hljs-keyword">var</span> <span class="hljs-built_in">seq</span>[T]): T =</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="52"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-literal">result</span> = stack[^<span class="hljs-number">1</span>]</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="53"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  stack.setLen(stack.len - <span class="hljs-number">1</span>)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="54"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"> </div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="55"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-comment"># Convenience template to execute an operation over two operands from the stack</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="56"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">template</span> execute[T](stack: <span class="hljs-keyword">var</span> <span class="hljs-built_in">seq</span>[T], operation: untyped): untyped <span class="hljs-meta">{.dirty.}</span> =</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="57"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-keyword">let</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="58"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    a = stack[^<span class="hljs-number">1</span>]</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="59"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    b = stack[^<span class="hljs-number">2</span>]</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="60"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  stack.setLen(stack.len - <span class="hljs-number">2</span>)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="61"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  stack.push(operation)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="62"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"> </div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="63"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-comment"># Then define all our commands using our macro</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="64"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">defineCommands(<span class="hljs-type">Commands</span>, docstrings, runCommand):</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="65"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-type">Plus</span> = <span class="hljs-string">"+"</span>; <span class="hljs-string">"Adds two numbers"</span>:</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="66"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    stack.execute(a + b)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="67"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-type">Minus</span> = <span class="hljs-string">"-"</span>; <span class="hljs-string">"Subtract two numbers"</span>:</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="68"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    stack.execute(b - a)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="69"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-type">Multiply</span> = <span class="hljs-string">"*"</span>; <span class="hljs-string">"Multiplies two numbers"</span>:</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="70"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    stack.execute(a * b)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="71"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-type">Divide</span> = <span class="hljs-string">"/"</span>; <span class="hljs-string">"Divides two numbers"</span>:</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="72"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    stack.execute(b / a)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="73"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-type">Pop</span> = <span class="hljs-string">"pop"</span>; <span class="hljs-string">"Pops a number off the stack"</span>:</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="74"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">discard</span> stack.pop</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="75"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-type">StackSwap</span> = <span class="hljs-string">"swap"</span>; <span class="hljs-string">"Swaps the two bottom elements on the stack"</span>:</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="76"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">let</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="77"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      a = stack[^<span class="hljs-number">1</span>]</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="78"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      b = stack[^<span class="hljs-number">2</span>]</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="79"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    stack[^<span class="hljs-number">1</span>] = b</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="80"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    stack[^<span class="hljs-number">2</span>] = a</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="81"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-type">StackRotate</span> = <span class="hljs-string">"rot"</span>; <span class="hljs-string">"Rotates the stack one level"</span>:</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="82"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    stack.insert(stack.pop, <span class="hljs-number">0</span>)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="83"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-type">Help</span> = <span class="hljs-string">"help"</span>; <span class="hljs-string">"Lists all the commands with documentation"</span>:</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="84"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    echo <span class="hljs-string">"Commands:"</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="85"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">for</span> command <span class="hljs-keyword">in</span> <span class="hljs-type">Commands</span>:</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="86"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      echo <span class="hljs-string">"\t"</span>, command, <span class="hljs-string">"\t"</span>, docstrings[command]</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="87"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-type">Exit</span> = <span class="hljs-string">"exit"</span>; <span class="hljs-string">"Exits the program"</span>:</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="88"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    quit <span class="hljs-number">0</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="89"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"> </div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="90"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-comment"># Program main loop, read input from stdin, run our template to parse the</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="91"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-comment"># command and run the corresponding operation. if that fails try to push it as</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="92"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-comment"># a number. Print out our "stack" for every iteration of the loop</span></div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="93"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">while</span> <span class="hljs-literal">true</span>:</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="94"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">  <span class="hljs-keyword">for</span> command <span class="hljs-keyword">in</span> <span class="hljs-literal">stdin</span>.readLine.split(<span class="hljs-string">" "</span>):</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="95"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">try</span>:</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="96"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      runCommand(command)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="97"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">except</span>:</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="98"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">      stack.push parseFloat(command)</div></td></tr><tr><td class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="99"></div></td><td class="hljs-ln-code"><div class="hljs-ln-line">    echo stack, <span class="hljs-string">" - "</span>, command</div></td></tr></tbody></table></code></pre>

<h2>Final remarks</h2>

<p>As we can see from the final result our operation definitions are now
 collected in one place. We create the enum, the docstring array, and 
the case switch in the same place. Since all of this is simple rewritten
 to valid Nim code at the AST level it will still evaluate to the same 
code as we started with, which means it will still have all the type 
safety and speed as the original version. Since we also made our macro 
accept arguments we can easily create multiple different classes of 
commands and put them in different modules or treat them differently in 
our main loop. Now you might say that the macro itself is just more code
 that needs to be maintained and that is true. But maintaining one piece
 of code that does a simple transformation, and another that does 
high-level program logic is in my opinion easier than mainting the 
original spaghetti. Especially if we take into consideration that after 
we've split this across modules it would be easy to change the format of
 every such block by simply changing the macro. So I hope this helps to 
show how a powerful tool like metaprogramming can indeed increase code 
read- and maintainability instead of being a hindrance to both.</p>				<p>
		</p><div class="readmore"><a href="https://peterme.net/">View all entries</a>		</div>
		</div>
		</div>
	<div id="footer">
		<a href="http://www.couchcms.com/" title="CouchCMS - Simple Open-Source Content Management" style="">Powered by CouchCMS</a>
	</div>
</div>
<script src="Welcome%20to%20Peter's%20DevLog%20-%20Metaprogramming%20and%20read-%20and%20maintainability%20in%20Nim_files/functions.js"></script>
<script>
var codeblocks = document.getElementsByTagName("code");
var i;
for (i = 0; i < codeblocks.length; i++){
    codeblocks[i].innerHTML = codeblocks[i].innerHTML.replace(/^[\r\n]+/, "");
}
hljs.initHighlightingOnLoad();
hljs.initLineNumbersOnLoad({singleLine: true});
</script>




</body></html>
<!-- Page generated by CouchCMS - Simple Open-Source Content Management -->